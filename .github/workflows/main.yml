name: CI for App Backend

on:
push:
branches: [main, develop]
pull_request:
branches: [main, develop]

jobs:
build-and-test:
runs-on: ubuntu-latest

services:
  mariadb:
    image: mariadb:12.0.2
    env:
      MYSQL_ROOT_PASSWORD: 1111
      MYSQL_DATABASE: my_login_db
    ports:
      - 3306:3306

steps:
  - name: Checkout code
    uses: actions/checkout@v4

  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: '3.13'

  - name: Install dependencies
    run: |
      pip install --upgrade pip
      pip install -r requirements.txt
      pip install flake8 pytest pytest-cov

  - name: Lint with flake8
    run: flake8 . --count --max-complexity=10 --max-line-length=127 --statistics

  - name: Run tests with pytest
    env:
      PYTHONPATH: .
    run: pytest --cov=./ --cov-report=xml

  - name: Set up Docker Buildx
    uses: docker/setup-buildx-action@v3

  - name: Cache Docker layers
    uses: actions/cache@v4
    with:
      path: /tmp/.buildx-cache
      key: ${{ runner.os }}-buildx-${{ github.sha }}
      restore-keys: |
        ${{ runner.os }}-buildx-

  - name: Build Docker image
    run: |
      docker buildx build \
        --cache-from=type=local,src=/tmp/.buildx-cache \
        --cache-to=type=local,dest=/tmp/.buildx-cache \
        -t fastapi-app .
